<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BetCashback Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0f13; --bg2: #16161e; --card: #1c1c26; --border: rgba(255,255,255,0.08);
    --accent: #00e5a0; --red: #ff4d6d; --yellow: #ffd166; --blue: #5b8dee;
    --text: #eeeef8; --text2: #8888aa; --text3: #44445a;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; font-size: 14px; }
  
  #login { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
  .login-box { background: var(--bg2); border: 1px solid var(--border); border-radius: 16px; padding: 40px; width: 360px; }
  .login-logo { font-size: 22px; font-weight: 700; color: var(--accent); margin-bottom: 24px; }
  
  #app { display: none; }
  .layout { display: flex; min-height: 100vh; }
  .sidebar { width: 220px; background: var(--bg2); border-right: 1px solid var(--border); padding: 20px 0; flex-shrink: 0; position: fixed; top: 0; left: 0; bottom: 0; }
  .sidebar-logo { font-size: 18px; font-weight: 700; color: var(--accent); padding: 0 20px 24px; }
  .nav-link { display: flex; align-items: center; gap: 10px; padding: 10px 20px; cursor: pointer; transition: all 0.15s; color: var(--text2); }
  .nav-link:hover { background: rgba(255,255,255,0.04); color: var(--text); }
  .nav-link.active { background: rgba(0,229,160,0.08); color: var(--accent); border-right: 2px solid var(--accent); }
  .nav-icon { font-size: 16px; }
  
  .main { margin-left: 220px; padding: 24px; flex: 1; }
  
  .page { display: none; }
  .page.active { display: block; }
  
  h1 { font-size: 22px; font-weight: 700; margin-bottom: 20px; }
  
  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
  .stat-box { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
  .stat-box .label { font-size: 11px; font-weight: 600; color: var(--text2); letter-spacing: 0.8px; text-transform: uppercase; }
  .stat-box .value { font-size: 28px; font-weight: 700; margin-top: 6px; }
  .stat-box .value.green { color: var(--accent); }
  .stat-box .value.yellow { color: var(--yellow); }
  .stat-box .value.blue { color: var(--blue); }
  .stat-box .value.red { color: var(--red); }
  
  .toolbar { display: flex; gap: 10px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
  .filter-btn { padding: 7px 14px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; border: 1px solid var(--border); background: var(--card); color: var(--text2); transition: all 0.15s; }
  .filter-btn:hover { border-color: rgba(255,255,255,0.15); color: var(--text); }
  .filter-btn.active { background: rgba(0,229,160,0.1); border-color: var(--accent); color: var(--accent); }
  .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.15s; }
  .btn-primary { background: var(--accent); color: #000; }
  .btn-primary:hover { opacity: 0.9; }
  .btn-danger { background: rgba(255,77,109,0.15); color: var(--red); border: 1px solid rgba(255,77,109,0.3); }
  .btn-success { background: rgba(0,229,160,0.15); color: var(--accent); border: 1px solid rgba(0,229,160,0.3); }
  .btn-sm { padding: 5px 10px; font-size: 12px; }
  
  .table-wrap { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
  table { width: 100%; border-collapse: collapse; }
  th { background: var(--bg2); padding: 12px 16px; text-align: left; font-size: 11px; font-weight: 700; color: var(--text2); letter-spacing: 0.8px; text-transform: uppercase; border-bottom: 1px solid var(--border); }
  td { padding: 12px 16px; border-bottom: 1px solid var(--border); vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(255,255,255,0.02); }
  
  .badge { display: inline-block; padding: 3px 8px; border-radius: 20px; font-size: 11px; font-weight: 700; }
  .badge-submitted { background: rgba(91,141,238,0.15); color: var(--blue); }
  .badge-in_review { background: rgba(255,209,102,0.15); color: var(--yellow); }
  .badge-approved { background: rgba(0,229,160,0.15); color: var(--accent); }
  .badge-paid { background: rgba(0,229,160,0.25); color: var(--accent); }
  .badge-rejected { background: rgba(255,77,109,0.15); color: var(--red); }
  
  .risk-bar { display: flex; align-items: center; gap: 6px; }
  .risk-dot { width: 8px; height: 8px; border-radius: 50%; }
  .risk-low { background: var(--accent); }
  .risk-mid { background: var(--yellow); }
  .risk-high { background: var(--red); }
  
  .actions { display: flex; gap: 6px; }
  
  input[type=text], input[type=password], textarea, select {
    width: 100%; background: var(--bg2); border: 1px solid var(--border);
    border-radius: 8px; padding: 10px 14px; color: var(--text); font-family: inherit; font-size: 14px;
    outline: none; transition: border-color 0.2s;
  }
  input:focus, textarea:focus, select:focus { border-color: var(--accent); }
  label { font-size: 12px; font-weight: 600; color: var(--text2); display: block; margin-bottom: 6px; }
  .field { margin-bottom: 14px; }
  
  /* MODAL */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; align-items: center; justify-content: center; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--bg2); border: 1px solid var(--border); border-radius: 16px; width: 540px; max-width: 95vw; max-height: 90vh; overflow-y: auto; padding: 24px; }
  .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; }
  .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 16px; }
  .btn-cancel { background: var(--card); color: var(--text2); }
  
  .thumb-grid { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
  .thumb { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; cursor: pointer; border: 1px solid var(--border); }
  .thumb:hover { border-color: var(--accent); }
  
  .claim-detail { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
  .detail-item .d-label { font-size: 11px; color: var(--text2); font-weight: 600; margin-bottom: 3px; }
  .detail-item .d-value { font-weight: 600; }
  
  .pagination { display: flex; gap: 8px; align-items: center; margin-top: 16px; }
  .page-btn { padding: 6px 12px; border-radius: 6px; cursor: pointer; background: var(--card); border: 1px solid var(--border); color: var(--text2); }
  .page-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }
  
  #lightbox { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 200; align-items: center; justify-content: center; cursor: zoom-out; }
  #lightbox.open { display: flex; }
  #lightbox img { max-width: 95vw; max-height: 95vh; object-fit: contain; border-radius: 8px; }
  
  .search-input { padding: 8px 14px; border-radius: 8px; background: var(--card); border: 1px solid var(--border); color: var(--text); font-family: inherit; font-size: 13px; width: 220px; outline: none; }
  .search-input:focus { border-color: var(--accent); }
  
  .broadcast-area { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; max-width: 600px; }
  .broadcast-area h2 { font-size: 16px; font-weight: 700; margin-bottom: 16px; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login">
  <div class="login-box">
    <div class="login-logo">üéØ BetCashback Admin</div>
    <div class="field">
      <label>Backend URL</label>
      <input type="text" id="login-url" placeholder="https://your-app.onrender.com">
    </div>
    <div class="field">
      <label>Admin Secret</label>
      <input type="password" id="login-secret" placeholder="–í–∞—à ADMIN_SECRET">
    </div>
    <button class="btn btn-primary" style="width:100%;padding:12px" onclick="doLogin()">–í–æ–π—Ç–∏</button>
    <div id="login-error" style="color:var(--red);font-size:13px;margin-top:12px;display:none"></div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="layout">
    <div class="sidebar">
      <div class="sidebar-logo">üéØ BetCash Admin</div>
      <div class="nav-link active" onclick="showPage('dashboard')" id="nav-dashboard"><span class="nav-icon">üìä</span> –î–∞—à–±–æ—Ä–¥</div>
      <div class="nav-link" onclick="showPage('claims')" id="nav-claims"><span class="nav-icon">üìã</span> –ó–∞—è–≤–∫–∏</div>
      <div class="nav-link" onclick="showPage('users')" id="nav-users"><span class="nav-icon">üë•</span> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
      <div class="nav-link" onclick="showPage('broadcast')" id="nav-broadcast"><span class="nav-icon">üì¢</span> –†–∞—Å—Å—ã–ª–∫–∞</div>
      <div style="position:absolute;bottom:20px;left:0;right:0;padding:0 20px">
        <button class="btn" style="width:100%;background:var(--card);color:var(--text2)" onclick="doLogout()">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <div class="main">
      <!-- DASHBOARD -->
      <div class="page active" id="page-dashboard">
        <h1>–î–∞—à–±–æ—Ä–¥</h1>
        <div class="stats-grid" id="stats-grid">
          <div class="stat-box"><div class="label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div><div class="value blue" id="s-users">‚Äî</div></div>
          <div class="stat-box"><div class="label">–ó–∞—è–≤–æ–∫ –≤—Å–µ–≥–æ</div><div class="value" id="s-claims">‚Äî</div></div>
          <div class="stat-box"><div class="label">–û–∂–∏–¥–∞—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</div><div class="value yellow" id="s-pending">‚Äî</div></div>
          <div class="stat-box"><div class="label">–í—ã–ø–ª–∞—á–µ–Ω–æ</div><div class="value green" id="s-paid">‚Äî</div></div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–æ–ª-–≤–æ</th><th>–°—É–º–º–∞ –∫—ç—à–±—ç–∫–∞</th></tr></thead>
            <tbody id="stats-table"></tbody>
          </table>
        </div>
      </div>

      <!-- CLAIMS -->
      <div class="page" id="page-claims">
        <h1>–ó–∞—è–≤–∫–∏</h1>
        <div class="toolbar">
          <div class="filter-btn active" onclick="filterClaims('',this)">–í—Å–µ</div>
          <div class="filter-btn" onclick="filterClaims('submitted',this)">–ù–æ–≤—ã–µ</div>
          <div class="filter-btn" onclick="filterClaims('in_review',this)">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</div>
          <div class="filter-btn" onclick="filterClaims('approved',this)">–û–¥–æ–±—Ä–µ–Ω—ã</div>
          <div class="filter-btn" onclick="filterClaims('rejected',this)">–û—Ç–∫–ª–æ–Ω–µ–Ω—ã</div>
          <div class="filter-btn" onclick="filterClaims('paid',this)">–í—ã–ø–ª–∞—á–µ–Ω—ã</div>
          <input class="search-input" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ ID –∫—É–ø–æ–Ω–∞..." oninput="searchClaims(this.value)" style="margin-left:auto">
          <button class="btn btn-primary" onclick="exportCSV()">‚¨á CSV</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–ë—É–∫–º–µ–∫–µ—Ä</th><th>–ü—Ä–æ–∏–≥—Ä—ã—à</th>
                <th>–ö—ç—à–±—ç–∫</th><th>–†–∏—Å–∫</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody id="claims-table"></tbody>
          </table>
        </div>
        <div class="pagination" id="claims-pagination"></div>
      </div>

      <!-- USERS -->
      <div class="page" id="page-users">
        <h1>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
        <div class="table-wrap">
          <table>
            <thead>
              <tr><th>TG ID</th><th>–ò–º—è</th><th>Username</th><th>–ó–∞—è–≤–æ–∫</th><th>–í—ã–ø–ª–∞—á–µ–Ω–æ</th><th>–†–µ—Ñ</th><th>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</th></tr>
            </thead>
            <tbody id="users-table"></tbody>
          </table>
        </div>
      </div>

      <!-- BROADCAST -->
      <div class="page" id="page-broadcast">
        <h1>–†–∞—Å—Å—ã–ª–∫–∞</h1>
        <div class="broadcast-area">
          <h2>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</h2>
          <div class="field">
            <label>–ê—É–¥–∏—Ç–æ—Ä–∏—è</label>
            <select id="bc-filter">
              <option value="all">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
              <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ (–±—ã–ª–∏ –∑–∞—è–≤–∫–∏ –∑–∞ 30 –¥–Ω–µ–π)</option>
              <option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ (–Ω–µ—Ç –∑–∞—è–≤–æ–∫ –∑–∞ 30 –¥–Ω–µ–π)</option>
            </select>
          </div>
          <div class="field">
            <label>–°–æ–æ–±—â–µ–Ω–∏–µ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç HTML: &lt;b&gt;, &lt;i&gt;, &lt;a&gt;)</label>
            <textarea id="bc-message" placeholder="–ü—Ä–∏–≤–µ—Ç! üéØ –¢–æ–ø-5 –∫—ç—à–±—ç–∫–æ–≤ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–∏..." style="height:140px"></textarea>
          </div>
          <div style="display:flex;gap:10px;align-items:center">
            <button class="btn btn-primary" onclick="sendBroadcast()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</button>
            <div id="bc-result" style="font-size:13px;color:var(--text2)"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CLAIM MODAL -->
<div class="modal-overlay" id="modal-claim">
  <div class="modal">
    <div class="modal-title" id="modal-claim-title">–ó–∞—è–≤–∫–∞ #‚Äî</div>
    <div class="claim-detail" id="modal-claim-detail"></div>
    <div>
      <div style="font-size:12px;font-weight:600;color:var(--text2);margin-bottom:8px">–°–ö–†–ò–ù–®–û–¢–´</div>
      <div class="thumb-grid" id="modal-thumbs"></div>
    </div>
    <hr style="border-color:var(--border);margin:16px 0">
    <div class="field">
      <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π / –ø—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞</label>
      <textarea id="modal-note" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Å–∫—Ä–∏–Ω –Ω–µ —á–∏—Ç–∞–µ—Ç—Å—è, –∫—É–ø–æ–Ω –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç..."></textarea>
    </div>
    <div class="field" id="modal-tx-field" style="display:none">
      <label>TX Hash (–¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ –í—ã–ø–ª–∞—á–µ–Ω–æ)</label>
      <input type="text" id="modal-tx" placeholder="0x...">
    </div>
    <div class="modal-footer">
      <button class="btn btn-cancel" onclick="closeModal('modal-claim')">–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="btn btn-danger btn-sm" onclick="updateClaimStatus('rejected')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
      <button class="btn" style="background:rgba(255,209,102,0.15);color:var(--yellow);border:1px solid rgba(255,209,102,0.3)" onclick="updateClaimStatus('in_review')">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</button>
      <button class="btn btn-success btn-sm" onclick="updateClaimStatus('approved')">–û–¥–æ–±—Ä–∏—Ç—å</button>
      <button class="btn btn-primary btn-sm" id="btn-paid" onclick="handlePaidClick()">–û–ø–ª–∞—á–µ–Ω–æ ‚úì</button>
    </div>
  </div>
</div>

<!-- LIGHTBOX -->
<div id="lightbox" onclick="this.classList.remove('open')">
  <img id="lightbox-img" src="">
</div>

<script>
let API = '';
let SECRET = '';
let currentClaims = [];
let currentClaimId = null;
let claimFilter = '';
let currentPage = 1;
const PAGE_SIZE = 20;

function doLogin() {
  API = document.getElementById('login-url').value.trim().replace(/\/$/, '');
  SECRET = document.getElementById('login-secret').value.trim();
  if (!API || !SECRET) { showLoginError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'); return; }
  
  fetch(API + '/admin/stats', { headers: { 'x-admin-secret': SECRET } })
    .then(r => { if (!r.ok) throw new Error(); return r.json(); })
    .then(() => {
      localStorage.setItem('bcAdminUrl', API);
      localStorage.setItem('bcAdminSecret', SECRET);
      document.getElementById('login').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      loadDashboard();
    })
    .catch(() => showLoginError('–ù–µ–≤–µ—Ä–Ω—ã–π URL –∏–ª–∏ —Å–µ–∫—Ä–µ—Ç'));
}

function doLogout() {
  localStorage.removeItem('bcAdminUrl');
  localStorage.removeItem('bcAdminSecret');
  location.reload();
}

function showLoginError(msg) {
  const el = document.getElementById('login-error');
  el.textContent = msg; el.style.display = 'block';
}

function adminFetch(path, options = {}) {
  return fetch(API + path, {
    ...options,
    headers: { 'x-admin-secret': SECRET, 'Content-Type': 'application/json', ...options.headers }
  }).then(r => { if (!r.ok) throw new Error(r.statusText); return r.json(); });
}

function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name)?.classList.add('active');
  document.getElementById('nav-' + name)?.classList.add('active');
  
  if (name === 'dashboard') loadDashboard();
  if (name === 'claims') loadClaims();
  if (name === 'users') loadUsers();
}

// ---- DASHBOARD ----
async function loadDashboard() {
  try {
    const data = await adminFetch('/admin/stats');
    setEl('s-users', data.users?.total || 0);
    
    const totalClaims = data.claims?.reduce((s,r) => s + parseInt(r.cnt), 0) || 0;
    setEl('s-claims', totalClaims);
    
    const pending = data.claims?.find(r => r.status === 'submitted')?.cnt || 0;
    setEl('s-pending', pending);
    
    const paid = data.payouts?.total_paid || 0;
    setEl('s-paid', formatRub(paid));
    
    const statusLabels = { submitted:'–ù–æ–≤—ã–µ', in_review:'–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ', approved:'–û–¥–æ–±—Ä–µ–Ω—ã', rejected:'–û—Ç–∫–ª–æ–Ω–µ–Ω—ã', paid:'–í—ã–ø–ª–∞—á–µ–Ω—ã' };
    const tbody = data.claims?.map(r => `
      <tr>
        <td><span class="badge badge-${r.status}">${statusLabels[r.status]||r.status}</span></td>
        <td>${r.cnt}</td>
        <td>${formatRub(r.amount)}</td>
      </tr>`).join('') || '';
    setEl('stats-table', tbody);
  } catch(e) { console.error(e); }
}

// ---- CLAIMS ----
async function loadClaims(page = 1) {
  currentPage = page;
  try {
    const url = `/admin/claims?page=${page}&limit=${PAGE_SIZE}${claimFilter ? '&status=' + claimFilter : ''}`;
    const data = await adminFetch(url);
    currentClaims = data;
    renderClaimsTable(data);
  } catch(e) { console.error(e); }
}

function renderClaimsTable(claims) {
  const tbody = document.getElementById('claims-table');
  if (!claims.length) { tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--text2);padding:32px">–ù–µ—Ç –∑–∞—è–≤–æ–∫</td></tr>'; return; }
  tbody.innerHTML = claims.map(c => {
    const risk = parseInt(c.risk_score);
    const riskClass = risk > 60 ? 'risk-high' : risk > 30 ? 'risk-mid' : 'risk-low';
    return `<tr>
      <td style="font-weight:700">#${c.id}</td>
      <td>${c.first_name || ''} ${c.username ? '@' + c.username : ''}</td>
      <td>${c.bookmaker_name || c.bookmaker_id}</td>
      <td>${formatRub(c.loss_amount_rub)}</td>
      <td style="color:var(--accent);font-weight:700">${formatRub(c.cashback_amount_rub)} <small style="color:var(--text2)">(${c.cashback_percent}%)</small></td>
      <td><div class="risk-bar"><div class="risk-dot ${riskClass}"></div>${risk}</div></td>
      <td><span class="badge badge-${c.status}">${statusLabel(c.status)}</span></td>
      <td style="color:var(--text2)">${formatDate(c.created_at)}</td>
      <td><button class="btn btn-sm" style="background:var(--bg2);border:1px solid var(--border);color:#fff" onclick="openClaim(${c.id})">–û—Ç–∫—Ä—ã—Ç—å</button></td>
    </tr>`;
  }).join('');
}

function filterClaims(status, el) {
  claimFilter = status;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  loadClaims();
}

function searchClaims(val) {
  if (!val) { renderClaimsTable(currentClaims); return; }
  const filtered = currentClaims.filter(c => 
    c.bet_id?.includes(val) || String(c.id).includes(val) || c.username?.includes(val)
  );
  renderClaimsTable(filtered);
}

function openClaim(id) {
  currentClaimId = id;
  const c = currentClaims.find(c => c.id === id);
  if (!c) return;
  
  document.getElementById('modal-claim-title').textContent = `–ó–∞—è–≤–∫–∞ #${c.id}`;
  document.getElementById('modal-note').value = c.admin_note || '';
  document.getElementById('modal-tx').value = c.tx_hash || '';
  document.getElementById('modal-tx-field').style.display = 'none';
  
  const detail = document.getElementById('modal-claim-detail');
  detail.innerHTML = [
    { label: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', value: `${c.first_name || ''} ${c.username ? '@' + c.username : '(ID:' + c.user_id + ')'}` },
    { label: '–ë—É–∫–º–µ–∫–µ—Ä', value: c.bookmaker_name || c.bookmaker_id },
    { label: '–ü–∞—Ä—Ç–Ω—ë—Ä ID', value: c.affiliate_player_id || '‚Äî' },
    { label: '–ö—É–ø–æ–Ω', value: c.bet_id || '‚Äî' },
    { label: '–î–∞—Ç–∞ —Å—Ç–∞–≤–∫–∏', value: c.bet_date ? formatDate(c.bet_date) : '‚Äî' },
    { label: '–ü—Ä–æ–∏–≥—Ä—ã—à', value: formatRub(c.loss_amount_rub) },
    { label: '–ö—ç—à–±—ç–∫', value: `${formatRub(c.cashback_amount_rub)} (${c.cashback_percent}%)` },
    { label: '–†–∏—Å–∫-—Å–∫–æ—Ä', value: `${c.risk_score}/100` },
    { label: '–°—Ç–∞—Ç—É—Å', value: `<span class="badge badge-${c.status}">${statusLabel(c.status)}</span>` },
    { label: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π', value: c.comment || '‚Äî' },
    { label: 'TX Hash', value: c.tx_hash || '‚Äî' },
  ].map(d => `<div class="detail-item"><div class="d-label">${d.label}</div><div class="d-value">${d.value}</div></div>`).join('');
  
  // Thumbnails
  const thumbs = document.getElementById('modal-thumbs');
  const attachments = c.attachments?.filter(a => a && a.url && a.url !== 'null') || [];
  if (attachments.length === 0) {
    thumbs.innerHTML = '<div style="color:var(--text2);font-size:13px">–ù–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</div>';
  } else {
    thumbs.innerHTML = attachments.map(a => {
      const imgUrl = a.url.startsWith('http') ? a.url : API + a.url;
      return `<img class="thumb" src="${imgUrl}" 
       onclick="openLightbox('${imgUrl}')" 
       title="${a.is_dup ? '‚ö†Ô∏è –î—É–±–ª–∏–∫–∞—Ç!' : ''}" 
       style="${a.is_dup ? 'border-color:var(--red)' : ''}"
       onerror="this.style.display='none'">`;
    }).join('');
  }
  
  openModal('modal-claim');
}

function showTxField() {
  document.getElementById('modal-tx-field').style.display = 'block';
}

function handlePaidClick() {
  const txField = document.getElementById('modal-tx-field');
  if (txField.style.display === 'none' || txField.style.display === '') {
    txField.style.display = 'block';
    document.getElementById('btn-paid').textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É ‚úì';
    document.getElementById('modal-tx').focus();
  } else {
    updateClaimStatus('paid');
  }
}

async function updateClaimStatus(status) {
  if (!currentClaimId) return;
  const note = document.getElementById('modal-note').value;
  const txHash = document.getElementById('modal-tx').value;
  
  if (status === 'paid' && !txHash) {
    alert('–í–≤–µ–¥–∏—Ç–µ TX Hash –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–í—ã–ø–ª–∞—á–µ–Ω–æ"'); return;
  }
  
  try {
    await adminFetch(`/admin/claims/${currentClaimId}`, {
      method: 'PATCH',
      body: JSON.stringify({ status, admin_note: note, tx_hash: txHash || undefined })
    });
    closeModal('modal-claim');
    loadClaims(currentPage);
    loadDashboard();
  } catch(e) {
    alert('–û—à–∏–±–∫–∞: ' + e.message);
  }
}

// ---- USERS ----
async function loadUsers() {
  try {
    const data = await adminFetch('/admin/users');
    const tbody = data.map(u => `
      <tr>
        <td style="font-family:monospace;font-size:12px">${u.id}</td>
        <td>${u.first_name || ''}</td>
        <td style="color:var(--text2)">${u.username ? '@' + u.username : '‚Äî'}</td>
        <td>${u.claim_count || 0}</td>
        <td style="color:var(--accent);font-weight:600">${formatRub(u.total_paid)}</td>
        <td>${u.referrer_id ? '‚úì ' + u.referrer_id : '‚Äî'}</td>
        <td style="color:var(--text2)">${formatDate(u.created_at)}</td>
      </tr>`).join('');
    setEl('users-table', tbody);
  } catch(e) { console.error(e); }
}

// ---- BROADCAST ----
async function sendBroadcast() {
  const message = document.getElementById('bc-message').value.trim();
  const filter = document.getElementById('bc-filter').value;
  if (!message) { alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è'); return; }
  if (!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É (${filter})? –≠—Ç–æ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) return;
  
  const result = document.getElementById('bc-result');
  result.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...';
  
  try {
    const data = await adminFetch('/admin/broadcast', {
      method: 'POST',
      body: JSON.stringify({ message, filter })
    });
    result.textContent = `‚úì –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${data.sent}, –æ—à–∏–±–æ–∫: ${data.failed}`;
    document.getElementById('bc-message').value = '';
  } catch(e) {
    result.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
  }
}

async function exportCSV() {
  try {
    const res = await fetch(API + '/admin/export/claims', { headers: { 'x-admin-secret': SECRET } });
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'claims_' + new Date().toISOString().split('T')[0] + '.csv';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  } catch(e) { alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞'); }
}

function openLightbox(src) {
  document.getElementById('lightbox-img').src = src;
  document.getElementById('lightbox').classList.add('open');
}

// HELPERS
function setEl(id, html) { const el = document.getElementById(id); if (el) el.innerHTML = html; }
function formatRub(n) { return Math.round(parseFloat(n) || 0).toLocaleString('ru-RU') + ' ‚ÇΩ'; }
function formatDate(d) { if (!d) return '‚Äî'; return new Date(d).toLocaleDateString('ru-RU', { day:'2-digit', month:'2-digit', year:'2-digit' }); }
function statusLabel(s) { return { submitted:'–ù–æ–≤–∞—è', in_review:'–ü—Ä–æ–≤–µ—Ä–∫–∞', approved:'–û–¥–æ–±—Ä–µ–Ω–∞', rejected:'–û—Ç–∫–ª–æ–Ω–µ–Ω–∞', paid:'–í—ã–ø–ª–∞—á–µ–Ω–∞' }[s] || s; }
function openModal(id) { document.getElementById(id)?.classList.add('open'); }
function closeModal(id) { document.getElementById(id)?.classList.remove('open'); }

document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); });
});

// Auto-login if saved
window.addEventListener('load', () => {
  const url = localStorage.getItem('bcAdminUrl');
  const secret = localStorage.getItem('bcAdminSecret');
  if (url && secret) {
    document.getElementById('login-url').value = url;
    document.getElementById('login-secret').value = secret;
    API = url; SECRET = secret;
    doLogin();
  }
});
</script>
</body>
</html>
